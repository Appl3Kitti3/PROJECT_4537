<!DOCTYPE html>
<html>
  <head>
    <title>Login</title>
    <link rel="stylesheet" href="./public/styles/styles.css" />
    <link rel="stylesheet" href="./public/styles/authPanel.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style></style>
  </head>

  <body>
    <div class="main_container">
      <div
        class="form_container container col-xl-10 col-xxl-8 px-4 py-5 shadow-lg bg-body-tertiary"
      >
        <div class="row align-items-center g-lg-5 py-5">
          <div id="panel" class="col-lg-7 text-center text-lg-start">
            <h1 class="display-4 fw-bold lh-1 text-body-emphasis mb-3">
              Just Choose Your Own Adventure!
            </h1>
            <p class="col-lg-10 fs-4">
              Log in and let your imaginations run wild with our AI model that
              will generate a story based on your prompt!
            </p>
          </div>
          <div class="col-md-10 mx-auto col-lg-5">
            <!-- The action calls the API with respected body from the Form -->
            <form id="loginForm"
              onsubmit="onLogin(event)"
              class="p-4 p-md-5 border rounded-3 bg-body-tertiary"
            >
              <div class="form-floating mb-3">
                <input
                  type="email"
                  class="form-control"
                  id="floatingInput"
                  placeholder="name@example.com"
                />
                <label for="floatingInput"> Email address </label>
              </div>

              <div class="form-floating mb-3">
                <input
                  type="password"
                  class="form-control"
                  id="floatingPassword"
                  placeholder="Password"
                />
                <label for="floatingPassword"> Password </label>
              </div>

              <div class="checkbox mb-3">
                <label>
                  <input type="checkbox" value="remember-me" /> Remember me
                </label>
              </div>

              <button
                id="loginButton"
                class="w-100 btn btn-lg btn-primary"
                type="submit"
              >
                Log In
              </button>
              <hr class="my-4" />
              <small class="text-body-primary"
                >Don't have an account?
                <span
                  class="anchorLinkDesign"
                  onclick="window.location.href = 'signup.html'"
                  >Sign Up!</span
                ></small
              >
            </form>
          </div>
        </div>
      </div>
    </div>
    <script>
      const username = "Adventurer";
      const mockData = {
        title: `Your remaining usages, ${username}`,
        description: "You have 18 remaining out of 20 API consumptions left!",
      };

      const API_BASE = "http://localhost:8080";
      // "https://isa-term-project-e2902e646c5c.herokuapp.com";
      const onLogin = async (event) => {
        event.preventDefault(); // Prevent page reload on form submit

        // Disable the login button to prevent multiple submissions
        const loginButton = document.getElementById("loginButton");
        loginButton.toggleAttribute("disabled");

        // Collect email and password from input fields
        const email = document.getElementById("floatingInput").value;
        const password = document.getElementById("floatingPassword").value;

        try {
          // Make a POST request to the login API
          const response = await fetch(`${API_BASE}/api/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          // Parse the response JSON
          const data = await response.json();

          if (response.ok) {
            // If login is successful, store the JWT token in localStorage
            localStorage.setItem("token", data.token);

            // Display the remaining API usage (example mock)
            document.getElementById(
              "panel"
            ).innerHTML = `<h1 class="display-4 fw-bold lh-1 text-body-emphasis mb-3">
                    ${mockData.title}
                </h1>
                <p class="col-lg-10 fs-4">
                    ${mockData.description}
                </p>
                <button
                    class="w-50 btn btn-lg btn-primary"
                    onclick="window.location.href = 'home.html'">
                    Home
                </button>`;
          } else {
            // If login failed, show an alert with the error message
            alert(data.error || "Login failed. Please try again.");

            // Re-enable the login button
            loginButton.removeAttribute("disabled");
          }
        } catch (error) {
          // Handle network errors
          console.error("Error:", error);
          alert("Network error. Please try again later.");

          // Re-enable the login button
          loginButton.removeAttribute("disabled");
        }
      };
    </script>
    <script src="./public/scripts/authenicateScript.js"></script>
    <script src="./public/scripts/themeChanger.js"></script>
  </body>
</html>
